!function(){function I(){if(null!==v.node){v={node:null,map:{}},x=Math.floor(b/o.get("hosts").length),y=Math.floor(o.get("hosts").length*x/2),o.get("hosts").forEach(function(a,b){a.x=d/-2,a.y=b*x-y});var a=180+i,g=360-i,j=(g-a)/(o.get("tests").length-1);o.get("tests").forEach(function(a,b){a.x=g-b*j,a.y=c/2-h,a.xOffset=-f,a.depth=1}),a=i,g=180-i,j=(g-a)/(o.get("grading").length-1),o.get("grading").forEach(function(b,d){b.x=d*j+a,b.y=c/2-h,b.xOffset=f,b.depth=1}),s=[];var k,l,m,n=c/2-h;o.get("hosts").forEach(function(a){a.links.forEach(function(b){k=q[U(b)],k&&"reference"!==k.type&&(l=(k.x-90)*Math.PI/180,m=a.key+"-to-"+k.key,s.push({source:a,target:k,key:m,canonicalKey:m,x1:a.x+("test"===k.type?0:d),y1:a.y+e/2,x2:Math.cos(l)*n+k.xOffset,y2:Math.sin(l)*n}))})}),u=[],t.forEach(function(a,b){var c=(b[0].x-90)*Math.PI/180;a2=(b[1].x-90)*Math.PI/180,bulge=20,u.push({x1:Math.cos(c)*n+b[0].xOffset,y1:Math.sin(c)*n,xx:Math.cos((c+a2)/2)*(n+bulge)+b[0].xOffset,yy:Math.sin((c+a2)/2)*(n+bulge),x2:Math.cos(a2)*n+b[1].xOffset,y2:Math.sin(a2)*n})}),window.location.hash="",M()}}function J(a,b){if(v.node===a&&b!==!0)return"host"===a.type?void(window.location.href="#"+a.slug):(v.node.children.forEach(function(a){a.children=a._group}),void N());if(a.isGroup)return v.node.children.forEach(function(a){a.children=a._group}),a.parent.children=a.parent._children,void N();a=q[a.canonicalKey],p.forEach(function(a){a.parent=null,a.children=[],a._children=[],a._group=[],a.canonicalKey=a.key,a.xOffset=0}),v.node=a,v.node.children=r.get(a.canonicalKey),v.map={};var c=0;v.node.children.forEach(function(b){v.map[b.key]=!0,b._children=r.get(b.key).filter(function(b){return b.canonicalKey!==a.canonicalKey}),b._children=JSON.parse(JSON.stringify(b._children)),b._children.forEach(function(a){a.canonicalKey=a.key,a.key=b.key+"-"+a.key,v.map[a.key]=!0});var d=b.key+"-group",e=b._children.length;b._group=[{isGroup:!0,key:d+"-group-key",canonicalKey:d,name:e,count:e,xOffset:0}],v.map[d]=!0,c+=e}),v.node.children.forEach(function(a){a.children=c>50?a._group:a._children}),window.location.hash=v.node.key,N()}function K(){w={node:null,map:{}},T()}function L(a){w.node!==a&&(w.node=a,w.map={},w.map[a.key]=!0,a.key!==a.canonicalKey?(w.map[a.parent.canonicalKey]=!0,w.map[a.parent.canonicalKey+"-to-"+a.canonicalKey]=!0,w.map[a.canonicalKey+"-to-"+a.parent.canonicalKey]=!0):(r.get(a.canonicalKey).forEach(function(b){w.map[b.canonicalKey]=!0,w.map[a.canonicalKey+"-"+b.canonicalKey]=!0}),s.forEach(function(a){w.map[a.source.canonicalKey]&&w.map[a.target.canonicalKey]&&(w.map[a.canonicalKey]=!0)})),T())}function M(){P(),E.selectAll("path").attr("d",function(a){return B([[a.x1,a.y1],[a.x1,a.y1],[a.x1,a.y1]])}).transition().duration(l).ease(m).attr("d",function(a){return B([[a.x1,a.y1],[a.target.xOffset*g,0],[a.x2,a.y2]])}),R(o.get("hosts")),O(d3.merge([o.get("tests"),o.get("grading")])),Q([]),S(u),H.html('<a href="page-03.html">بررسی سایت‌های رتبه ۱۰۱ تا ۱۵۰</a>'),K(),T()}function N(){var a=z.nodes(v.node);a.forEach(function(a){1===a.depth&&(a.y-=20)}),s=z.links(a),s.forEach(function(a){"host"===a.source.type?a.key=a.source.canonicalKey+"-to-"+a.target.canonicalKey:a.key=a.target.canonicalKey+"-to-"+a.source.canonicalKey,a.canonicalKey=a.key}),P(),E.selectAll("path").transition().duration(l).ease(m).attr("d",A),R([]),O(a),Q([v.node]),S([]);var b="";v.node.description&&(b=v.node.description),H.html(b),K(),T()}function O(a){var a=G.selectAll(".node").data(a,V),b=a.enter().append("g").attr("transform",function(a){var b=a.parent?a.parent:{xOffset:0,x:0,y:0};return"translate("+b.xOffset+",0)rotate("+(b.x-90)+")translate("+b.y+")"}).attr("class","node").on("mouseover",L).on("mouseout",K).on("click",J);b.append("circle").attr("r",0),b.append("text").attr("stroke","#f5f5f5").attr("stroke-width",4).attr("class","label-stroke"),b.append("text").attr("font-size",0).attr("class","label"),a.transition().duration(l).ease(m).attr("transform",function(a){if(a===v.node)return null;var b=a.isGroup?a.y+(7+a.count):a.y;return"translate("+a.xOffset+",0)rotate("+(a.x-90)+")translate("+b+")"}),a.selectAll("circle").transition().duration(l).ease(m).attr("r",function(a){return a==v.node?100:a.isGroup?1+a.count:4.5}),a.selectAll("text").transition().duration(l).ease(m).attr("dy",".3em").attr("font-size",function(a){return 0===a.depth,15}).text(function(a){return a.name}).attr("text-anchor",function(a){return a===v.node||a.isGroup?"middle":a.x<180?"start":"end"}).attr("transform",function(a){return a===v.node?null:a.isGroup?a.x>180?"rotate(180)":null:a.x<180?"translate("+k+")":"rotate(180)translate(-"+k+")"}),a.selectAll("text.label-stroke").attr("display",function(a){return 1===a.depth?"block":"none"}),a.exit().remove()}function P(){var a=E.selectAll("path").data(s,V);a.enter().append("path").attr("d",function(a){var b=a.source?{x:a.source.x,y:a.source.y}:{x:0,y:0};return A({source:b,target:b})}).attr("class","link"),a.exit().remove()}function Q(c){var d=C.selectAll(".detail").data(c,V),e=d.enter().append("g").attr("class","detail"),f=c[0];if(f&&"host"===f.type){var g=e.append("a").attr("xlink:href",function(a){return"#"+a.slug});g.append("text").attr("fill",n).attr("text-anchor","middle").attr("y",(j+k)*-1).text(function(a){return"Test Score: "+a.host})}else if(f&&"test"===f.type)e.append("text").attr("fill","#aaa").attr("text-anchor","middle").attr("y",(j+k)*-1).text("Test");else if(f&&"grade"===f.type){var h=d.selectAll(".pair").data(t.get(f.group).filter(function(a){return a!==f}),V);h.enter().append("text").attr("fill","#aaa").attr("text-anchor","middle").attr("y",function(a,b){return 2*(j+k)+b*(j+k)}).text(function(a){}).attr("class","pair").on("click",J),e.append("text").attr("fill",n).attr("text-anchor","middle").attr("y",(j+k)*-1).text("Grade: "),h.exit().remove()}d.exit().remove();var i=C.selectAll(".check-all-hosts").data(c);i.enter().append("text").attr("text-anchor","start").attr("x",a/-2+k).attr("y",b/2-k).text("مشاهده‌ی کل اطلاعات").attr("class","check-all-hosts").on("click",I),i.exit().remove()}function R(a){var a=F.selectAll(".host").data(a,V),b=a.enter().append("g").attr("class","host").on("mouseover",L).on("mouseout",K).on("click",J);b.append("rect").attr("x",d/-2).attr("y",e/-2).attr("width",d).attr("height",e).transition().duration(l).ease(m).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}),b.append("text").attr("x",function(a){return d/-2+k}).attr("y",function(a){return e/-2+j}).attr("fill","#fff").text(function(a){return a.name}).transition().duration(l).ease(m).attr("x",function(a){return a.x+k}).attr("y",function(a){return a.y+10}),a.exit().selectAll("rect").transition().duration(l).ease(m).attr("x",function(a){return d/-2}).attr("y",function(a){return e/-2}),a.exit().selectAll("text").transition().duration(l).ease(m).attr("x",function(a){return d/-2+k}).attr("y",function(a){return e/-2+j}),a.exit().transition().duration(l).remove()}function S(a){F.selectAll("path").data(a)}function T(){F.selectAll("rect").attr("fill",function(a){return W(a,"#000",n,"#000")}),E.selectAll("path").attr("stroke",function(a){return W(a,"#aaa",n,"#aaa")}).attr("stroke-width",function(a){return W(a,"1.5px","2.5px","1px")}).attr("opacity",function(a){return W(a,.4,.75,.3)}).sort(function(a,b){if(!w.node)return 0;var c=w.map[a.canonicalKey]?1:0,d=w.map[b.canonicalKey]?1:0;return c-d}),G.selectAll("circle").attr("fill",function(a){return a===v.node?"#000":"test"===a.type?W(a,"#666",n,"#000"):"grade"===a.type?"#fff":W(a,"#000",n,"#999")}).attr("stroke",function(a){return a===v.node?W(a,null,n,null):"test"===a.type?"#000":"grade"===a.type?W(a,"#000",n,"#000"):null}).attr("stroke-width",function(a){return a===v.node?W(a,null,2.5,null):"test"===a.type||"grade"===a.type?1.5:null}),G.selectAll("text.label").attr("fill",function(a){return a===v.node||a.isGroup?"#fff":W(a,"#000",n,"#999")})}function U(a){return a.toLowerCase().replace(/[ .,()]/g,"-")}function V(a){return a.key}function W(a,b,c,d){return null===w.node?b:w.map[a.key]?c:b}var o,p,q,r,s,t,u,x,y,a=800,b=650,c=b,d=200,e=16,f=20,g=8,h=70,i=30,j=15,k=10,l=1200,m="elastic",n="#0da4d3",v={},w={},z=d3.layout.tree().size([360,c/2-h]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth}),A=d3.svg.diagonal.radial().projection(function(a){return[a.y,a.x/180*Math.PI]}),B=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).interpolate("bundle").tension(.5),C=d3.select("#graph").append("svg").attr("width",a).attr("height",b).append("g").attr("transform","translate("+a/2+","+b/2+")"),E=(C.append("rect").attr("class","bg").attr({x:a/-2,y:b/-2,width:a,height:b,fill:"#f5f5f5"}).on("click",I),C.append("g").attr("class","links")),F=C.append("g").attr("class","hosts"),G=C.append("g").attr("class","nodes"),H=d3.select("#graph-info");d3.json("data-03.json",function(a,b){o=d3.map(b),p=d3.merge(o.values()),q={},t=d3.map(),p.forEach(function(a){a.key=U(a.name),a.canonicalKey=a.key,q[a.key]=a,a.group&&(t.has(a.group)||t.set(a.group,[]),t.get(a.group).push(a))}),r=d3.map(),o.get("hosts").forEach(function(a){a.links=a.links.filter(function(a){return"undefined"!=typeof q[U(a)]&&0!==a.indexOf("r-")}),r.set(a.key,a.links.map(function(b){var c=U(b);return"undefined"==typeof r.get(c)&&r.set(c,[]),r.get(c).push(a),q[c]}))});var c=window.location.hash.substring(1);c&&q[c]?J(q[c]):(I(),M()),window.onhashchange=function(){var a=window.location.hash.substring(1);a&&q[a]&&J(q[a],!0)}})}();